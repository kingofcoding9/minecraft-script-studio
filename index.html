<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-Web Creator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Load libraries first -->
    <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .btn-primary { background-color: #4f46e5; color: white; transition: background-color 0.2s; }
        .btn-primary:hover { background-color: #4338ca; }
        .btn-secondary { background-color: #6b7280; color: white; transition: background-color 0.2s; }
        .btn-secondary:hover { background-color: #4b5563; }
        .btn-outline { border: 1px solid #d1d5db; color: #374151; transition: background-color 0.2s, color 0.2s; }
        .btn-outline:hover { background-color: #f3f4f6; }
        .gemini-btn { background: linear-gradient(to right, #4f46e5, #9333ea); color: white; }
        #canvas { min-height: 400px; }
        .element-frame.selected {
            outline: 2px solid #4f46e5;
            box-shadow: 0 0 10px rgba(79, 70, 229, 0.5);
        }
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 50; }
        .modal-content { background-color: white; padding: 24px; border-radius: 8px; max-width: 500px; width: 90%; max-height: 90vh; overflow-y: auto;}
        .gemini-message.user { background-color: #eef2ff; text-align: right; }
        .gemini-message.assistant { background-color: #f3f4f6; }
    </style>
</head>
<body class="bg-gray-100">

<div id="app" class="flex flex-col h-screen">
    <!-- Header -->
    <header class="bg-white shadow-md p-3 flex justify-between items-center z-10 flex-shrink-0">
        <div class="flex items-center space-x-2">
            <img src="https://i.imgur.com/4VOsU9q.png" alt="Omni-Web Creator Logo" class="h-10 w-10">
            <h1 class="text-xl font-bold text-gray-800">Omni-Web Creator</h1>
            <span id="projectName" class="text-sm text-gray-500 ml-4">New Project</span>
        </div>
        <div class="flex items-center space-x-2">
            <button id="newProjectBtn" class="btn-outline px-3 py-1.5 rounded-md text-sm">New</button>
            <button id="saveProjectBtn" class="btn-outline px-3 py-1.5 rounded-md text-sm">Save</button>
            <button id="loadProjectBtn" class="btn-outline px-3 py-1.5 rounded-md text-sm">Load</button>
            <button id="generateWebsiteBtn" class="btn-primary px-4 py-1.5 rounded-md text-sm font-semibold">Export Website</button>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-1 flex overflow-hidden">
        <!-- Left Panel -->
        <aside class="w-80 bg-white p-4 overflow-y-auto flex-shrink-0 border-r">
            <!-- Pages -->
            <div class="mb-6">
                <h2 class="font-semibold mb-2">PAGES</h2>
                <div id="pageList" class="bg-gray-50 rounded-lg p-2 space-y-1"></div>
                <button id="addPageBtn" class="w-full mt-2 btn-secondary text-sm py-2 rounded-md">+ Add New Page</button>
            </div>
            <!-- Elements -->
            <div id="elements-panel" class="mb-6">
                 <h2 class="font-semibold mb-2">ELEMENTS</h2>
                 <div id="addElementBtns" class="grid grid-cols-2 gap-2">
                     <button data-type="header" class="p-2 border rounded-lg text-center hover:bg-gray-100">H1</br>Header</button>
                     <button data-type="subheader" class="p-2 border rounded-lg text-center hover:bg-gray-100">H2</br>Sub-Header</button>
                     <button data-type="paragraph" class="p-2 border rounded-lg text-center hover:bg-gray-100">¬∂</br>Paragraph</button>
                     <button data-type="image" class="p-2 border rounded-lg text-center hover:bg-gray-100">üñºÔ∏è</br>Image</button>
                     <button data-type="video" class="p-2 border rounded-lg text-center hover:bg-gray-100">üìπ</br>Video</button>
                     <button data-type="button" class="p-2 border rounded-lg text-center hover:bg-gray-100">üîò</br>Button</button>
                     <button data-type="dropdown" class="p-2 border rounded-lg text-center hover:bg-gray-100">‚ñº</br>Dropdown</button>
                 </div>
            </div>
            <!-- Properties -->
            <div id="properties-panel">
                <h2 class="font-semibold mb-2">PROPERTIES</h2>
                <div id="properties-content" class="space-y-4">
                    <p class="text-gray-500 text-sm">Select an element to see its properties.</p>
                </div>
            </div>
        </aside>

        <!-- Center Canvas -->
        <div class="flex-1 flex flex-col items-center justify-center p-4" id="canvas-bg">
            <div id="canvas-wrapper" class="w-full h-full shadow-lg rounded-lg overflow-hidden flex flex-col bg-white">
                <!-- Omni-Bot UI -->
                <div id="gemini-builder-ui" class="p-3 border-b space-y-2">
                    <!-- Bot Response Bubble -->
                    <div class="flex items-start space-x-2">
                        <img src="https://i.imgur.com/4VOsU9q.png" class="w-8 h-8 rounded-full flex-shrink-0" alt="Omni-Bot Avatar">
                        <div class="flex-grow bg-gray-100 p-2 rounded-lg rounded-tl-none">
                            <h3 class="text-xs font-semibold text-gray-900">Omni-Bot</h3>
                            <p id="gemini-status" class="text-sm text-gray-700">How can I help you build?</p>
                        </div>
                    </div>
                    <!-- User Input Form -->
                    <form id="gemini-builder-form" class="flex items-center space-x-2">
                        <input type="text" id="gemini-builder-input" placeholder="Your instructions..." class="w-full px-3 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-primary focus:border-primary">
                        <button type="submit" class="gemini-btn px-4 py-1.5 rounded-md text-sm">Send</button>
                    </form>
                </div>
                <!-- Website Preview -->
                <div class="flex-1 overflow-y-auto">
                    <div id="canvas" class="p-4"></div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- Footer -->
    <footer class="text-center text-xs text-gray-500 py-2 bg-white border-t">
        Made by king_of_coding, owned by Omni-Science
    </footer>
</div>

<!-- Modal Container -->
<div id="modalContainer"></div>
<input type="file" id="loadProjectInput" class="hidden" accept=".wsb">
<input type="file" id="uploadImageInput" class="hidden" accept="image/*">

<script>
    // Using a standard script tag with an IIFE to prevent global scope pollution
    // and avoid module loading issues with the external libraries.
    (function() {
        // The JSZip and saveAs libraries are loaded globally from the <head>
        // and are available here as JSZip and saveAs.

        document.addEventListener('DOMContentLoaded', () => {
            // --- DOM ELEMENTS ---
            const pageList = document.getElementById('pageList');
            const addPageBtn = document.getElementById('addPageBtn');
            const addElementBtns = document.querySelectorAll('#addElementBtns button');
            const propertiesContent = document.getElementById('properties-content');
            const canvas = document.getElementById('canvas');
            const canvasBg = document.getElementById('canvas-bg');
            const newProjectBtn = document.getElementById('newProjectBtn');
            const saveProjectBtn = document.getElementById('saveProjectBtn');
            const loadProjectBtn = document.getElementById('loadProjectBtn');
            const loadProjectInput = document.getElementById('loadProjectInput');
            const generateWebsiteBtn = document.getElementById('generateWebsiteBtn');
            const projectNameEl = document.getElementById('projectName');
            const geminiBuilderForm = document.getElementById('gemini-builder-form');
            const geminiBuilderInput = document.getElementById('gemini-builder-input');
            const geminiStatus = document.getElementById('gemini-status');
            
            // --- APP STATE ---
            let projectData = {};
            let currentPage = 'index.html';
            let selectedElementIndex = null;
            let dragData = { element: null, index: -1 };
            let builderChatHistory = [];
            
            // --- IMPORTANT: PASTE YOUR API KEY HERE ---
            const apiKey = "AIzaSyAswttOZbrNTdgPLxfhIJk1jpXjmVEjUb8"; 

            // --- INITIALIZATION ---
            function init() {
                newProject();
            }
            
            function newProject() {
                projectData = {
                    "index.html": {
                        elements: [],
                    },
                    themes: getDefaultThemes(),
                    currentTheme: 'Default',
                };
                currentPage = 'index.html';
                selectedElementIndex = null;
                projectNameEl.textContent = 'New Project';
                updateAll();
                geminiStatus.textContent = "How can I help you build?";
            }

            function getDefaultThemes() {
                return {
                    "Default": {
                        primary: '#4f46e5',
                        secondary: '#6b7280',
                        background: '#ffffff',
                        foreground: '#f3f4f6',
                        'text-primary': '#111827',
                        'text-secondary': '#6b7280',
                        accent: '#ec4899'
                    }
                };
            }
            
            function applyTheme() {
                const theme = projectData.themes[projectData.currentTheme];
                canvas.style.backgroundColor = theme.background;
                canvas.style.color = theme['text-primary'];
                canvasBg.style.backgroundColor = theme.foreground;
            }

            // --- CORE LOGIC ---
            function updateAll() {
                renderPageList();
                renderCanvas();
                renderPropertiesPanel();
                applyTheme();
            }
            
            function goToPage(pageName) {
                let key = pageName.trim();
                // If the name doesn't already end with .html, format it.
                // This handles raw names from user input or the AI.
                if (!key.endsWith('.html')) {
                    key = key.toLowerCase().replace(/[^a-z0-9]/g, '-') + '.html';
                }

                if (projectData[key]) {
                    currentPage = key;
                    unselectElement(); // This will trigger updateAll()
                } else {
                    console.warn(`Attempted to go to non-existent page: ${pageName} (resolved to key: ${key})`);
                }
            }

            function addPageAction(pageName) {
                if (!pageName) {
                    showConfirmModal("Page name cannot be empty. Please provide a valid name.", () => {});
                    return;
                }
                let formattedName = pageName.trim();
                if (!formattedName.endsWith('.html')) {
                    formattedName = formattedName.toLowerCase().replace(/[^a-z0-9]/g, '-') + '.html';
                }

                if (projectData[formattedName]) {
                    goToPage(formattedName);
                    return;
                }
                projectData[formattedName] = { elements: [] };
                goToPage(formattedName);
            }
            
            function addElement(type, properties = {}) {
                const newElement = {
                    type,
                    align: 'left',
                    link: '',
                    ...properties
                };
                // Set defaults if not provided in properties
                switch (type) {
                    case 'header': if (!newElement.content) newElement.content = "Main Header"; break;
                    case 'subheader': if (!newElement.content) newElement.content = "Sub-Header"; break;
                    case 'paragraph': if (!newElement.content) newElement.content = "This is a paragraph of text."; break;
                    case 'button': if (!newElement.content) newElement.content = "Clickable Button"; if (!newElement.href) newElement.href = "#"; break;
                    case 'image': 
                        if (!newElement.src) newElement.src = 'https://placehold.co/600x400/EEE/31343C?text=Placeholder'; 
                        if (!newElement.scale) newElement.scale = 100; 
                        if (!newElement.alt) newElement.alt = 'Placeholder image';
                        break;
                    case 'video': if (!newElement.src) newElement.src = 'https://www.youtube.com/embed/dQw4w9WgXcQ'; break;
                    case 'dropdown':
                        if (!newElement.name) newElement.name = 'Dropdown';
                        if (!newElement.items) newElement.items = [{ text: 'Item 1', href: '#' }, { text: 'Item 2', href: '#' }];
                        break;
                }
                if(projectData[currentPage]) {
                    projectData[currentPage].elements.push(newElement);
                    selectElement(projectData[currentPage].elements.length - 1);
                } else {
                    console.error("Current page does not exist in project data.");
                }
            }
            
            function selectElement(index) {
                selectedElementIndex = index;
                updateAll();
            }
            
            function unselectElement() {
                selectedElementIndex = null;
                updateAll();
            }

            function deleteElement() {
                if (selectedElementIndex !== null) {
                    projectData[currentPage].elements.splice(selectedElementIndex, 1);
                    unselectElement();
                }
            }
            
            function updateElementProperty(prop, value) {
                if (selectedElementIndex !== null) {
                    projectData[currentPage].elements[selectedElementIndex][prop] = value;
                    updateAll();
                }
            }

            function updateDropdownItem(itemIndex, prop, value) {
                if (selectedElementIndex !== null) {
                    const element = projectData[currentPage].elements[selectedElementIndex];
                    if (element?.type === 'dropdown' && element.items?.[itemIndex]) {
                        element.items[itemIndex][prop] = value;
                        // Only re-render canvas to prevent properties panel from losing focus on text input.
                        renderCanvas();
                    }
                }
            }

            function addDropdownItem() {
                if (selectedElementIndex !== null) {
                    const element = projectData[currentPage].elements[selectedElementIndex];
                    if (element && element.type === 'dropdown') {
                        element.items.push({ text: 'New Item', href: '#' });
                        updateAll();
                    }
                }
            }

            function removeDropdownItem(itemIndex) {
                 if (selectedElementIndex !== null) {
                    const element = projectData[currentPage].elements[selectedElementIndex];
                    if (element && element.type === 'dropdown' && element.items[itemIndex]) {
                        element.items.splice(itemIndex, 1);
                        updateAll();
                    }
                }
            }

            // --- RENDERING ---
            function renderPageList() {
                pageList.innerHTML = '';
                Object.keys(projectData).forEach(key => {
                    if (key === 'themes' || key === 'currentTheme') return;
                    const pageItem = document.createElement('div');
                    pageItem.className = `p-2 rounded-md cursor-pointer text-sm ${key === currentPage ? 'bg-indigo-100 text-indigo-700 font-semibold' : 'hover:bg-gray-100'}`;
                    pageItem.textContent = key;
                    pageItem.onclick = () => {
                        goToPage(key);
                    };
                    pageList.appendChild(pageItem);
                });
            }

            function renderCanvas() {
                canvas.innerHTML = '';
                const elements = projectData[currentPage]?.elements || [];
                elements.forEach((element, index) => {
                    const elWrapper = document.createElement('div');
                    elWrapper.className = `element-frame p-2 relative ${index === selectedElementIndex ? 'selected' : ''}`;
                    elWrapper.dataset.index = index;
                    elWrapper.draggable = true;

                    const content = renderElement(element);
                    elWrapper.appendChild(content);

                    elWrapper.addEventListener('click', (e) => {
                        e.stopPropagation();
                        selectElement(index);
                    });
                    
                    elWrapper.addEventListener('dragstart', (e) => {
                        dragData.element = elWrapper;
                        dragData.index = index;
                        e.dataTransfer.effectAllowed = 'move';
                        setTimeout(() => elWrapper.classList.add('opacity-50'), 0);
                    });

                    elWrapper.addEventListener('dragover', (e) => {
                        e.preventDefault();
                        const target = e.target.closest('.element-frame');
                        if (target && target !== dragData.element) {
                            const rect = target.getBoundingClientRect();
                            const isAfter = (e.clientY - rect.top) > rect.height / 2;
                            if (isAfter) {
                                target.parentNode.insertBefore(dragData.element, target.nextSibling);
                            } else {
                                target.parentNode.insertBefore(dragData.element, target);
                            }
                        }
                    });

                    elWrapper.addEventListener('dragend', () => {
                        elWrapper.classList.remove('opacity-50');
                        
                        const originalElements = projectData[currentPage].elements;
                        
                        const reorderedElements = Array.from(canvas.querySelectorAll('.element-frame')).map(frame => {
                            const originalIndex = parseInt(frame.dataset.index, 10);
                            return originalElements[originalIndex];
                        });

                        const draggedElement = originalElements[dragData.index];
                        const newIndex = reorderedElements.indexOf(draggedElement);

                        projectData[currentPage].elements = reorderedElements;
                        
                        dragData = { element: null, index: -1 };
                        
                        selectElement(newIndex);
                    });


                    canvas.appendChild(elWrapper);
                });
            }
            
            function renderElement(element) {
                const theme = projectData.themes[projectData.currentTheme];
                const container = document.createElement('div');
                container.style.textAlign = element.align;

                let el;
                switch(element.type) {
                    case 'header':
                        el = document.createElement('h1');
                        el.textContent = element.content;
                        el.style.fontSize = '2em';
                        el.style.fontWeight = 'bold';
                        break;
                    case 'subheader':
                        el = document.createElement('h2');
                        el.textContent = element.content;
                        el.style.fontSize = '1.5em';
                        el.style.fontWeight = 'bold';
                        break;
                    case 'paragraph':
                        el = document.createElement('p');
                        el.textContent = element.content;
                        break;
                    case 'button':
                        el = document.createElement('a');
                        el.textContent = element.content;
                        el.href = element.href || '#';
                        el.onclick = (e) => e.preventDefault(); // Prevent navigation inside editor
                        el.style.display = 'inline-block';
                        el.style.padding = '10px 20px';
                        el.style.borderRadius = '5px';
                        el.style.textDecoration = 'none';
                        el.style.backgroundColor = theme.primary;
                        el.style.color = 'white';
                        break;
                    case 'image':
                        el = document.createElement('img');
                        el.src = element.src;
                        el.alt = element.alt || ''; // Add alt attribute for accessibility
                        el.style.maxWidth = '100%';
                        el.style.width = `${element.scale}%`;
                        el.onerror = function() { // Fallback for broken image links
                            this.onerror=null;
                            this.src='https://placehold.co/600x400/EEE/31343C?text=Image+Not+Found';
                        };
                        break;
                    case 'video':
                        el = document.createElement('iframe');
                        el.src = element.src;
                        el.width = "560";
                        el.height = "315";
                        el.frameBorder = "0";
                        el.allow = "autoplay; fullscreen; picture-in-picture";
                        el.style.maxWidth = '100%';
                        el.style.display = 'inline-block';
                        break;
                    case 'dropdown':
                        el = document.createElement('div');
                        el.className = 'relative inline-block';
                        const btn = document.createElement('button');
                        btn.textContent = element.name;
                        btn.style.backgroundColor = theme['text-primary'];
                        btn.style.color = theme.background;
                        btn.style.padding = '12px';
                        const content = document.createElement('div');
                        content.className = 'hidden absolute bg-white shadow-lg p-2 rounded';
                        element.items.forEach(item => {
                            const a = document.createElement('a');
                            a.textContent = item.text;
                            a.href = item.href || '#';
                            a.onclick = (e) => e.preventDefault();
                            a.className = 'block p-2 hover:bg-gray-100';
                            content.appendChild(a);
                        });
                        el.appendChild(btn);
                        el.appendChild(content);
                        el.onmouseenter = () => content.classList.remove('hidden');
                        el.onmouseleave = () => content.classList.add('hidden');
                        break;
                }

                if (element.link) {
                    const linkWrapper = document.createElement('a');
                    linkWrapper.href = '#'; // In-editor link is disabled
                    linkWrapper.onclick = (e) => e.preventDefault();
                    linkWrapper.style.cursor = 'pointer';
                    linkWrapper.style.position = 'relative';
                    linkWrapper.style.display = 'inline-block';
                    linkWrapper.title = `Links to: ${element.link}`;
                    const linkIcon = document.createElement('span');
                    linkIcon.textContent = 'üîó';
                    linkIcon.style.position = 'absolute';
                    linkIcon.style.top = '0';
                    linkIcon.style.right = '0';
                    linkIcon.style.fontSize = '0.75em';
                    linkIcon.style.background = 'rgba(255,255,255,0.8)';
                    linkIcon.style.borderRadius = '50%';
                    linkIcon.style.padding = '2px';
                    linkWrapper.appendChild(el);
                    linkWrapper.appendChild(linkIcon);
                    container.appendChild(linkWrapper);
                } else {
                    container.appendChild(el);
                }
                return container;
            }

            function renderPropertiesPanel() {
                propertiesContent.innerHTML = '';
                if (selectedElementIndex === null || !projectData[currentPage] || !projectData[currentPage].elements[selectedElementIndex]) {
                     // Global Styles
                    propertiesContent.innerHTML = `
                        <h3 class="font-semibold text-sm mb-2">Global Page Styles</h3>
                        <div class="space-y-2">
                            <label class="block text-xs text-gray-600">Website Theme</label>
                            <div class="flex items-center">
                                <select id="themeSelector" class="w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm"></select>
                                <button id="themeManagerBtn" class="p-1.5 ml-2 border rounded-md hover:bg-gray-100">‚öôÔ∏è</button>
                            </div>
                        </div>`;
                    const themeSelector = document.getElementById('themeSelector');
                    Object.keys(projectData.themes).forEach(name => {
                        const option = document.createElement('option');
                        option.value = name;
                        option.textContent = name;
                        if (name === projectData.currentTheme) option.selected = true;
                        themeSelector.appendChild(option);
                    });
                    themeSelector.onchange = (e) => {
                        projectData.currentTheme = e.target.value;
                        updateAll();
                    };
                    document.getElementById('themeManagerBtn').onclick = showThemeManagerModal;
                    return;
                }

                const element = projectData[currentPage].elements[selectedElementIndex];
                
                // Alignment
                const alignContainer = document.createElement('div');
                const alignLabel = document.createElement('label');
                alignLabel.textContent = 'Alignment';
                alignLabel.className = 'block text-xs font-medium text-gray-700 mb-1';
                alignContainer.appendChild(alignLabel);
                const alignBtns = document.createElement('div');
                alignBtns.className = 'grid grid-cols-3 gap-1 rounded-md bg-gray-200 p-1';
                ['left', 'center', 'right'].forEach(align => {
                    const btn = document.createElement('button');
                    btn.textContent = align.charAt(0).toUpperCase();
                    btn.className = `px-2 py-1 text-xs rounded ${element.align === align ? 'bg-white font-semibold shadow' : ''}`;
                    btn.onclick = () => updateElementProperty('align', align);
                    alignBtns.appendChild(btn);
                });
                alignContainer.appendChild(alignBtns);
                propertiesContent.appendChild(alignContainer);

                // Element-specific props
                if (['header', 'subheader', 'paragraph'].includes(element.type)) {
                    propertiesContent.appendChild(createTextInput('Content', element.content, (val) => updateElementProperty('content', val), true));
                }
                if (element.type === 'button') {
                    propertiesContent.appendChild(createTextInput('Content', element.content, (val) => updateElementProperty('content', val)));
                    propertiesContent.appendChild(createUrlInput('URL', element.href, (val) => updateElementProperty('href', val)));
                }
                if (element.type === 'image') {
                    propertiesContent.appendChild(createTextInput('Source URL', element.src, (val) => updateElementProperty('src', val)));
                    propertiesContent.appendChild(createTextInput('Alt Text', element.alt, (val) => updateElementProperty('alt', val)));
                    propertiesContent.appendChild(createRangeInput('Scale', element.scale, (val) => updateElementProperty('scale', val), 10, 200));
                }
                if (element.type === 'video') {
                    propertiesContent.appendChild(createTextInput('Source URL', element.src, (val) => updateElementProperty('src', val)));
                }
                if (element.type === 'dropdown') {
                    propertiesContent.appendChild(createTextInput('Button Text', element.name, (val) => updateElementProperty('name', val)));
                    
                    const itemsLabel = document.createElement('label');
                    itemsLabel.className = 'block text-xs font-medium text-gray-700 mb-1 mt-4';
                    itemsLabel.textContent = 'Dropdown Items';
                    propertiesContent.appendChild(itemsLabel);

                    const itemsContainer = document.createElement('div');
                    itemsContainer.className = 'space-y-2 border p-2 rounded-md bg-gray-50';
                    
                    element.items.forEach((item, index) => {
                        const itemWrapper = document.createElement('div');
                        itemWrapper.className = 'flex items-center space-x-2';
                        
                        const textInput = document.createElement('input');
                        textInput.type = 'text';
                        textInput.value = item.text;
                        textInput.placeholder = 'Item Text';
                        textInput.className = 'w-full px-2 py-1 border border-gray-300 rounded-md text-sm';
                        textInput.oninput = (e) => updateDropdownItem(index, 'text', e.target.value);

                        const hrefInput = document.createElement('input');
                        hrefInput.type = 'text';
                        hrefInput.value = item.href;
                        hrefInput.placeholder = 'Link URL';
                        hrefInput.className = 'w-full px-2 py-1 border border-gray-300 rounded-md text-sm';
                        hrefInput.oninput = (e) => updateDropdownItem(index, 'href', e.target.value);

                        const removeBtn = document.createElement('button');
                        removeBtn.textContent = '-';
                        removeBtn.className = 'flex-shrink-0 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs hover:bg-red-600';
                        removeBtn.onclick = () => removeDropdownItem(index);

                        const inputsWrapper = document.createElement('div');
                        inputsWrapper.className = 'flex-grow space-y-1';
                        inputsWrapper.appendChild(textInput);
                        inputsWrapper.appendChild(hrefInput);

                        itemWrapper.appendChild(inputsWrapper);
                        itemWrapper.appendChild(removeBtn);
                        itemsContainer.appendChild(itemWrapper);
                    });
                    propertiesContent.appendChild(itemsContainer);

                    const addItemBtn = document.createElement('button');
                    addItemBtn.textContent = '+ Add Item';
                    addItemBtn.className = 'w-full mt-2 btn-outline text-sm py-1.5 rounded-md';
                    addItemBtn.onclick = addDropdownItem;
                    propertiesContent.appendChild(addItemBtn);
                }

                // Universal Link Property (excluding buttons which have their own href)
                if (element.type !== 'button') {
                    propertiesContent.appendChild(createUrlInput('Element Link', element.link, (val) => updateElementProperty('link', val)));
                }

                // Delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Delete Element';
                deleteBtn.className = 'w-full mt-4 btn-outline border-red-500 text-red-500 hover:bg-red-50 text-sm py-2 rounded-md';
                deleteBtn.onclick = () => showConfirmModal('Are you sure you want to delete this element?', deleteElement);
                propertiesContent.appendChild(deleteBtn);
            }
            
            // --- PROPERTY INPUT CREATORS ---
            function createInputWrapper(label) {
                const wrapper = document.createElement('div');
                wrapper.className = 'mb-2';
                const labelEl = document.createElement('label');
                labelEl.className = 'block text-xs font-medium text-gray-700 mb-1';
                labelEl.textContent = label;
                wrapper.appendChild(labelEl);
                return wrapper;
            }
            
            function createTextInput(label, value, onChange, hasGemini = false) {
                const wrapper = createInputWrapper(label);
                const container = document.createElement('div');
                container.className = 'relative';

                const input = document.createElement('textarea');
                input.value = value;
                input.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-primary focus:border-primary resize-y';
                input.rows = 3;
                input.oninput = (e) => onChange(e.target.value);
                container.appendChild(input);

                if (hasGemini) {
                    const geminiBtn = document.createElement('button');
                    geminiBtn.className = 'gemini-btn absolute bottom-2 right-2 p-1 rounded-md text-xs flex items-center space-x-1';
                    geminiBtn.innerHTML = `‚ú®<span>Omni Assist</span>`;
                    geminiBtn.onclick = () => showAIGenerateModal(value, onChange);
                    container.appendChild(geminiBtn);
                }
                
                wrapper.appendChild(container);
                return wrapper;
            }

            function createUrlInput(label, value, onChange) {
                const wrapper = createInputWrapper(label);
                const datalistId = `pages-list-${Math.random().toString(36).substr(2, 9)}`;
                const input = document.createElement('input');
                input.type = 'text';
                input.value = value || '';
                input.setAttribute('list', datalistId);
                input.placeholder = 'https://... or select a page';
                input.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm';
                input.onchange = (e) => onChange(e.target.value);

                const datalist = document.createElement('datalist');
                datalist.id = datalistId;
                Object.keys(projectData).forEach(key => {
                    if (key !== 'themes' && key !== 'currentTheme' && key !== currentPage) {
                        const option = document.createElement('option');
                        option.value = key;
                        datalist.appendChild(option);
                    }
                });
                
                wrapper.appendChild(input);
                wrapper.appendChild(datalist);
                return wrapper;
            }

            function createRangeInput(label, value, onChange, min = 0, max = 100) {
                const wrapper = createInputWrapper(label);
                const container = document.createElement('div');
                container.className = 'flex items-center space-x-2';
                const input = document.createElement('input');
                input.type = 'range';
                input.min = min;
                input.max = max;
                input.value = value;
                input.className = 'w-full';
                const labelValue = document.createElement('span');
                labelValue.className = 'text-sm w-12 text-right';
                labelValue.textContent = `${value}%`;

                input.oninput = (e) => {
                    onChange(e.target.value);
                    labelValue.textContent = `${e.target.value}%`;
                };
                container.appendChild(input);
                container.appendChild(labelValue);
                wrapper.appendChild(container);
                return wrapper;
            }
            
            function createColorInput(label, value, onChange) {
                const wrapper = document.createElement('div');
                wrapper.className = 'flex items-center justify-between';
                const labelEl = document.createElement('label');
                labelEl.textContent = label;
                labelEl.className = 'text-sm';
                const input = document.createElement('input');
                input.type = 'color';
                input.value = value;
                input.className = 'w-8 h-8 p-0 border-none rounded';
                input.oninput = (e) => onChange(e.target.value);
                wrapper.appendChild(labelEl);
                wrapper.appendChild(input);
                return wrapper;
            }
            
            function createSelectInput(label, value, options, onChange) {
                const wrapper = createInputWrapper(label);
                const select = document.createElement('select');
                select.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm';
                options.forEach(opt => {
                    const option = document.createElement('option');
                    option.value = opt;
                    option.textContent = opt;
                    if(opt === value) option.selected = true;
                    select.appendChild(option);
                });
                select.onchange = (e) => onChange(e.target.value);
                wrapper.appendChild(select);
                return wrapper;
            }

            // --- PROJECT MGMT ---
            function saveProject() {
                try {
                    const blob = new Blob([JSON.stringify(projectData, null, 2)], { type: 'application/json' });
                    saveAs(blob, 'my-omni-website.wsb');
                } catch (error) {
                    console.error("Failed to save project:", error);
                    showConfirmModal("Error saving project.", () => {});
                }
            }
            
            function loadProject(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            projectData = JSON.parse(e.target.result);
                            currentPage = 'index.html';
                            unselectElement();
                        } catch (error) {
                            console.error("Failed to load project:", error);
                            showConfirmModal("Invalid project file.", () => {});
                        }
                    };
                    reader.readAsText(file);
                }
            }
            
            async function generateWebsite() {
                const zip = new JSZip();
                Object.keys(projectData).forEach(key => {
                    if (key !== 'themes' && key !== 'currentTheme') {
                        const pageHtml = generatePageHTML(key, projectData[key]);
                        zip.file(key, pageHtml);
                    }
                });
                const content = await zip.generateAsync({ type: 'blob' });
                saveAs(content, 'website.zip');
            }

            function generatePageHTML(pageName, pageData) {
                const theme = projectData.themes[projectData.currentTheme];
                const title = pageName.replace('.html', '').replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());

                const bodyContent = pageData.elements.map(element => {
                    let style = `text-align: ${element.align};; margin: 16px 0;`;
                    let content = '';

                    switch(element.type) {
                        case 'header': content = `<h1 style="font-size:32px; font-weight: bold;">${element.content}</h1>`; break;
                        case 'subheader': content = `<h2 style="font-size:24px; font-weight: bold;">${element.content}</h2>`; break;
                        case 'paragraph': content = `<p>${element.content}</p>`; break;
                        case 'button': content = `<a href="${element.href}" class="btn-primary">${element.content}</a>`; break;
                        case 'image': content = `<img src="${element.src}" alt="${element.alt || ''}" style="max-width:100%; width:${element.scale}%; display:inline-block;">`; break;
                        case 'video': content = `<iframe src="${element.src}" width="560" height="315" style="max-width:100%; display:inline-block;" frameborder="0" allow="autoplay; fullscreen; picture-in-picture" allowfullscreen></iframe>`; break;
                        case 'dropdown':
                            const items = element.items.map(i => `<a href="${i.href}">${i.text}</a>`).join('');
                            content = `
                                <div class="dropdown" style="position:relative; display:inline-block;">
                                    <button class="dropdown-btn">${element.name}</button>
                                    <div class="dropdown-content">${items}</div>
                                </div>`;
                            break;
                    }
                    
                    if (element.link) {
                        return `<a href="${element.link}" style="text-decoration:none; color:inherit; display:block; ${style}">${content}</a>`;
                    }
                    return `<div style="${style}">${content}</div>`;
                }).join('\n');

                return `<!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>${title}</title>
            <style>
                body {
                    background-color: ${theme.background};
                    color: ${theme['text-secondary']};
                    font-family: "Inter", sans-serif;
                    margin: 2em;
                }
                h1, h2, h3, h4, h5, h6, p { color: ${theme['text-primary']}; }
                a { color: ${theme.primary}; }
                .btn-primary { background-color: ${theme.primary}; color: white; padding: 10px 20px; text-decoration:none; border-radius: 5px; display:inline-block; }
                .dropdown-btn { background-color:${theme['text-primary']}; color:${theme.background}; padding: 12px; font-size: 16px; border:none; cursor:pointer; }
                .dropdown-content { display:none; position:absolute; background-color:${theme.foreground}; min-width:160px; box-shadow:0 8px 16px 0 rgba(0,0,0,0.2); z-index:1; }
                .dropdown-content a { display:block; padding: 8px 16px; color: ${theme['text-primary']}; text-decoration: none; }
                .dropdown:hover .dropdown-content { display: block; }
                .dropdown-content a:hover { background-color: ${theme.accent}; }
            </style>
        </head>
        <body>
            ${bodyContent}
        </body>
        </html>`;
            }

            // --- GEMINI API ---
            function getSystemPrompt() {
                return `You are Omni-Bot, an expert AI assistant integrated into the Omni-Web Creator application. Your primary goal is to help users build websites byusing the tools available to you.

**CRITICAL RULES:**
1.  **NEVER WRITE CODE.** Your only output is a single, valid, complete JSON array of action objects. Do not write any text, explanation, or markdown outside of this JSON array.
2.  **THINK STEP-BY-STEP.** For complex requests, break the task down into a logical sequence of actions. For example, to add content to a different page, you MUST use the "goToPage" action first, then use "addElement". To modify an element, you must use "selectElement" first.
3.  **ALWAYS BE CONVERSATIONAL.** Use the "speak" action to confirm what you have done and to guide the user.
4.  **IMAGE SOURCING:** For image elements, you MUST use URLs from \`picsum.photos\` to ensure they are displayed correctly. For example, for a random 600x400 image, use \`https://picsum.photos/600/400\`. Do NOT use URLs from sites like Unsplash as they will be blocked.

**Available Actions:**
1.  **speak**: Provide a conversational response to the user.
    - params: { "text": "The message to display to the user." }
2.  **addElement**: Adds a new element to the *current* page.
    - params for text/button: { "type": "header" | "subheader" | "paragraph" | "button", "content": "The initial text content." }
    - params for media: { "type": "image" | "video", "src": "The URL of the image or video embed.", "alt": "A description of the image for accessibility." }
    - params for dropdown: { "type": "dropdown", "name": "The button text", "items": [{"text": "Item 1", "href": "#"}, {"text": "Item 2", "href": "#"}] }
3.  **addPage**: Creates a new page. The user will be switched to this new page.
    - params: { "name": "The name of the new page, e.g., 'about'" }
4.  **goToPage**: Switches the editor to a different page.
    - params: { "name": "The name of the page to switch to, e.g., 'about'" }
5.  **selectElement**: Selects an element on the canvas by its index (0-based).
    - params: { "index": 0 }
6.  **updateSelectedElement**: Modifies a property of the *currently selected* element. You MUST select an element first.
    - params: { "property": "content" | "align" | "href" | "src" | "name" | "items" | "alt", "value": "The new value." }
    - \`href\` is used for button links.
    - \`src\` is used for image/video URLs.
    - \`items\` is used for dropdowns and the value must be an array like: [{"text": "New Item", "href": "/page.html"}].

**Current Project State:**
- Existing Pages: [${Object.keys(projectData).filter(k => k !== 'themes' && k !== 'currentTheme').map(p => `'${p}'`).join(', ')}]
- Current Page: '${currentPage}'
- Number of Elements on this Page: ${projectData[currentPage] ? projectData[currentPage].elements.length : 0}
- Selected Element Index: ${selectedElementIndex === null ? 'None' : selectedElementIndex}

User's request will be provided next. Remember the critical rules. Respond ONLY with a single, complete JSON array.`;
            }

            async function callBuilderAssistantAPI(userPrompt) {
                geminiStatus.textContent = "Thinking...";
                builderChatHistory.push({ role: "user", parts: [{ text: userPrompt }] });
                
                if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                    geminiStatus.textContent = "Please add your Gemini API key in the script tag.";
                    return;
                }

                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = {
                    contents: builderChatHistory,
                    systemInstruction: { parts: [{ text: getSystemPrompt() }] },
                    generationConfig: { responseMimeType: "application/json" }
                };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) throw new Error(`API Error: ${response.status}`);
                    const result = await response.json();
                    const rawText = result.candidates?.[0]?.content?.parts?.[0]?.text;
                    if (rawText) {
                        try {
                            const jsonMatch = rawText.match(/(\[[\s\S]*\])/);
                            if (!jsonMatch) throw new Error("No valid JSON array found in the response.");
                            const cleanedText = jsonMatch[0];
                            const actions = JSON.parse(cleanedText);
                            await executeBuilderActions(actions);
                            builderChatHistory.push({ role: "model", parts: [{ text: rawText }] });
                        } catch (e) {
                            geminiStatus.textContent = "Couldn't understand that response. Try again?";
                            console.error("Failed to parse AI response:", rawText);
                            console.error("Parsing Error:", e);
                        }
                    } else {
                        geminiStatus.textContent = "Couldn't process that request.";
                    }
                } catch (error) {
                    console.error("Builder Assistant API call failed:", error);
                    geminiStatus.textContent = `Error: ${error.message}`;
                }
            }
            
            async function executeBuilderActions(actions) {
                if (!Array.isArray(actions)) {
                    console.error("Expected an array of actions, but got:", actions);
                    geminiStatus.textContent = "Sorry, I received an invalid response format.";
                    return;
                }

                for (const action of actions) {
                    switch (action.action) {
                        case 'speak':
                            geminiStatus.textContent = action.params.text;
                            break;
                        case 'addElement':
                            // Destructure type from params, pass the rest as properties object
                            const { type, ...properties } = action.params;
                            addElement(type, properties);
                            break;
                        case 'addPage':
                            addPageAction(action.params.name);
                            break;
                        case 'goToPage':
                            goToPage(action.params.name);
                            break;
                        case 'selectElement':
                            selectElement(action.params.index);
                            break;
                        case 'updateSelectedElement':
                            updateElementProperty(action.params.property, action.params.value);
                            break;
                        default:
                            console.warn(`Unknown action: ${action.action}`);
                    }
                    // Wait for the UI to update
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
            }

            async function callTextGeneratorAPI(prompt, retries = 3, delay = 1000) {
                 if (!apiKey || apiKey === "YOUR_API_KEY_HERE") {
                    return "Please add your Gemini API key in the script tag to use this feature.";
                }
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }], };
                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (!response.ok) {
                        if (response.status === 429 && retries > 0) {
                            await new Promise(res => setTimeout(res, delay));
                            return callTextGeneratorAPI(prompt, retries - 1, delay * 2);
                        }
                        throw new Error(`API request failed with status ${response.status}`);
                    }
                    const result = await response.json();
                    const candidate = result.candidates?.[0];
                    return candidate?.content?.parts?.[0]?.text || "Failed to generate content. Please try again.";
                } catch (error) {
                    console.error("Gemini API call failed:", error);
                    return `Error: ${error.message}`;
                }
            }

            // --- MODALS ---
            function showModal(title, content, showButtons = true, onSubmit) {
                const modalContainer = document.getElementById('modalContainer');
                modalContainer.innerHTML = '';
                const backdrop = document.createElement('div');
                backdrop.className = 'modal-backdrop';
                const modal = document.createElement('div');
                modal.className = 'modal-content';
                modal.innerHTML = `<h2 class="text-lg font-bold mb-4">${title}</h2>`;
                const form = document.createElement('form');
                form.className = 'space-y-4';
                if (typeof content === 'function') content(form);
                else {
                    content.forEach(field => {
                        const wrapper = createInputWrapper(field.label);
                        const input = document.createElement('input');
                        input.type = field.type;
                        input.name = field.name;
                        input.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm';
                        input.required = true;
                        wrapper.appendChild(input);
                        form.appendChild(wrapper);
                    });
                }
                if (showButtons) {
                    const btnContainer = document.createElement('div');
                    btnContainer.className = 'flex justify-end space-x-2 mt-6';
                    const cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.className = 'btn-outline px-4 py-1.5 rounded-md text-sm';
                    cancelBtn.onclick = () => modalContainer.innerHTML = '';
                    const submitBtn = document.createElement('button');
                    submitBtn.type = 'submit';
                    submitBtn.textContent = 'OK';
                    submitBtn.className = 'btn-primary px-4 py-1.5 rounded-md text-sm';
                    btnContainer.appendChild(cancelBtn);
                    btnContainer.appendChild(submitBtn);
                    form.appendChild(btnContainer);
                }
                form.onsubmit = (e) => {
                    e.preventDefault();
                    if (onSubmit) onSubmit(Object.fromEntries(new FormData(form).entries()));
                    modalContainer.innerHTML = '';
                };
                modal.appendChild(form);
                backdrop.appendChild(modal);
                modalContainer.appendChild(backdrop);
            }
            
            function showConfirmModal(message, onConfirm) {
                showModal('Are you sure?', (form) => {
                    const p = document.createElement('p');
                    p.textContent = message;
                    form.appendChild(p);
                }, true, onConfirm);
            }

            function showThemeManagerModal() {
                showModal('Theme Manager', (form) => {
                    const themes = projectData.themes;
                    const themeKeys = ['primary', 'secondary', 'background', 'foreground', 'text-primary', 'text-secondary', 'accent'];
                    let selectedTheme = projectData.currentTheme;
                    const selector = createSelectInput('Select Theme to Edit', selectedTheme, Object.keys(themes), (val) => {
                        selectedTheme = val;
                        updateEditor();
                    }).querySelector('select');
                    const editor = document.createElement('div');
                    editor.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4';
                    function updateEditor() {
                        editor.innerHTML = '';
                        const theme = themes[selectedTheme];
                        const isDefault = selectedTheme === 'Default';
                        themeKeys.forEach(key => {
                            const colorInput = createColorInput(key, theme[key], (val) => {
                                if (!isDefault) {
                                    themes[selectedTheme][key] = val;
                                    applyTheme();
                                    renderCanvas();
                                }
                            });
                            if (isDefault) colorInput.querySelectorAll('input').forEach(i => i.disabled = true);
                            editor.appendChild(colorInput);
                        });
                        if (isDefault) {
                            const notice = document.createElement('p');
                            notice.className = 'text-xs text-gray-500 col-span-2 text-center mt-2';
                            notice.textContent = 'Default theme is read-only. Create a new theme to customize colors.';
                            editor.appendChild(notice);
                        }
                    }
                    const newThemeContainer = document.createElement('div');
                    newThemeContainer.className = 'flex items-center space-x-2 mt-4';
                    const newThemeName = document.createElement('input');
                    newThemeName.type = 'text';
                    newThemeName.placeholder = 'New Theme Name';
                    newThemeName.className = 'flex-grow px-2 py-1.5 border border-gray-300 rounded-md text-sm';
                    const addThemeBtn = document.createElement('button');
                    addThemeBtn.type = 'button';
                    addThemeBtn.textContent = 'Add Theme';
                    addThemeBtn.className = 'btn-secondary px-3 py-1.5 rounded-md text-sm';
                    addThemeBtn.onclick = () => {
                        const name = newThemeName.value.trim();
                        if (name && !themes[name]) {
                            themes[name] = { ...themes[selectedTheme] };
                            projectData.currentTheme = name;
                            form.parentElement.parentElement.remove();
                            showThemeManagerModal();
                            updateAll();
                        } else showConfirmModal('Invalid or duplicate theme name.', () => {});
                    };
                    newThemeContainer.appendChild(newThemeName);
                    newThemeContainer.appendChild(addThemeBtn);
                    form.appendChild(selector.parentElement);
                    form.appendChild(editor);
                    form.appendChild(newThemeContainer);
                    updateEditor();
                    const closeBtn = document.createElement('button');
                    closeBtn.type = 'button';
                    closeBtn.textContent = 'Done';
                    closeBtn.className = 'btn-primary px-4 py-1.5 rounded-md text-sm float-right mt-4';
                    closeBtn.onclick = () => form.parentElement.parentElement.remove();
                    form.appendChild(closeBtn);
                }, false);
            }

            function showAIGenerateModal(currentText, onApply) {
                showModal('‚ú® Omni Assist', (form) => {
                    const promptPresets = [
                        { name: 'Generate', prompt: `Generate a short, engaging piece of text based on the following topic: `},
                        { name: 'Improve', prompt: `Rewrite the following text to be more clear, professional, and engaging: `},
                        { name: 'Summarize', prompt: `Summarize the following text into one concise sentence: `},
                    ];
                    const presetContainer = document.createElement('div');
                    presetContainer.className = 'flex flex-wrap gap-2 mb-2';
                    const promptTextarea = document.createElement('textarea');
                    promptPresets.forEach(preset => {
                        const btn = document.createElement('button');
                        btn.type = 'button';
                        btn.textContent = preset.name;
                        btn.className = 'btn-outline px-3 py-1 rounded-md text-xs';
                        btn.onclick = () => promptTextarea.value = preset.name === 'Generate' ? preset.prompt : `${preset.prompt}\n\n"${currentText}"`;
                        presetContainer.appendChild(btn);
                    });
                    form.appendChild(presetContainer);
                    promptTextarea.rows = 5;
                    promptTextarea.placeholder = 'Enter your prompt here, or use a preset above...';
                    promptTextarea.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm';
                    form.appendChild(promptTextarea);
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'mt-4 p-3 bg-gray-50 rounded-md border text-sm min-h-[50px]';
                    resultDiv.textContent = 'AI generation will appear here...';
                    form.appendChild(resultDiv);
                    const generateBtn = document.createElement('button');
                    generateBtn.type = 'button';
                    generateBtn.innerHTML = 'Generate Text';
                    generateBtn.className = 'gemini-btn w-full px-4 py-1.5 rounded-md text-sm mt-4';
                    generateBtn.onclick = async () => {
                        const prompt = promptTextarea.value;
                        if (!prompt) return;
                        generateBtn.innerHTML = '<div class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mx-auto"></div>';
                        generateBtn.disabled = true;
                        resultDiv.textContent = await callTextGeneratorAPI(prompt);
                        generateBtn.innerHTML = 'Generate Text';
                        generateBtn.disabled = false;
                    };
                    const buttonContainer = document.createElement('div');
                    buttonContainer.className = 'flex justify-end items-center space-x-2 mt-4';
                    const cancelBtn = document.createElement('button');
                    cancelBtn.type = 'button';
                    cancelBtn.textContent = 'Cancel';
                    cancelBtn.className = 'btn-outline px-4 py-1.5 rounded-md text-sm';
                    cancelBtn.onclick = () => form.parentElement.parentElement.remove();
                    const applyBtn = document.createElement('button');
                    applyBtn.type = 'button';
                    applyBtn.textContent = 'Apply';
                    applyBtn.className = 'btn-primary px-4 py-1.5 rounded-md text-sm';
                    applyBtn.onclick = () => {
                        const newText = resultDiv.textContent;
                        if (newText && newText !== 'AI generation will appear here...') {
                            onApply(newText);
                            form.parentElement.parentElement.remove();
                        }
                    };
                    form.appendChild(generateBtn);
                    buttonContainer.appendChild(cancelBtn);
                    buttonContainer.appendChild(applyBtn);
                    form.appendChild(buttonContainer);
                }, false);
            }

            // --- EVENT LISTENERS ---
            addPageBtn.addEventListener('click', () => {
                showModal('Add New Page', [{ type: 'text', name: 'pageName', label: 'Page Name (e.g., about)' }], true, (data) => addPageAction(data.pageName));
            });
            addElementBtns.forEach(btn => {
                btn.addEventListener('click', () => addElement(btn.dataset.type));
            });
            canvas.addEventListener('click', (e) => {
                if (!e.target.closest('.element-frame')) {
                    unselectElement();
                }
            });
            newProjectBtn.addEventListener('click', () => {
                showConfirmModal('Are you sure you want to start a new project? Unsaved changes will be lost.', newProject);
            });
            saveProjectBtn.addEventListener('click', saveProject);
            loadProjectBtn.addEventListener('click', () => loadProjectInput.click());
            loadProjectInput.addEventListener('change', loadProject);
            generateWebsiteBtn.addEventListener('click', generateWebsite);
            
            geminiBuilderForm.addEventListener('submit', (e) => {
                e.preventDefault();
                const prompt = geminiBuilderInput.value.trim();
                if (prompt) {
                    callBuilderAssistantAPI(prompt);
                    geminiBuilderInput.value = '';
                }
            });

            // --- KICK IT OFF ---
            init();
        });
    })();
</script>

</body>
</html>

