<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Omni-Web Creator - WYSIWYG Website Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --primary: #4f46e5;
            --secondary: #10b981;
            --background: #f3f4f6;
            --foreground: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --accent: #ec4899;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--background);
        }
        .control-panel { background-color: var(--foreground); }
        .canvas-preview { background-color: var(--foreground); }
        .btn-primary { background-color: var(--primary); color: white; transition: background-color 0.3s; }
        .btn-primary:hover { filter: brightness(90%); }
        .btn-secondary { background-color: var(--secondary); color: white; transition: background-color: 0.3s; }
        .btn-secondary:hover { filter: brightness(90%); }
        .btn-outline { border: 1px solid #d1d5db; color: var(--text-secondary); transition: all 0.3s; }
        .btn-outline:hover { background-color: #e5e7eb; color: var(--text-primary); }
        .element-frame {
            transition: box-shadow 0.2s, border-color 0.2s;
            cursor: grab;
            position: relative;
        }
        .element-frame.selected {
            box-shadow: 0 0 0 2px var(--primary);
            border-color: var(--primary);
        }
        .element-frame:hover {
            box-shadow: 0 0 0 2px #a5b4fc;
        }
        .placeholder {
            height: 50px;
            background-color: #e0e7ff;
            border: 2px dashed #a5b4fc;
            margin: 8px 0;
            border-radius: 8px;
        }
        .dragging {
            opacity: 0.5;
            cursor: grabbing;
        }
        .modal-backdrop {
            background-color: rgba(0,0,0,0.5);
            position: fixed;
            top: 0; left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            min-width: 300px;
            max-width: 500px;
        }
        .link-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background-color: var(--accent);
            color: white;
            border-radius: 9999px;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
    </style>
</head>
<body class="overflow-hidden">

    <div id="app" class="flex flex-col h-screen">
        <!-- Header -->
        <header class="bg-white shadow-md p-3 flex justify-between items-center z-10 flex-shrink-0">
            <div class="flex items-center space-x-2">
                <img src="https://i.imgur.com/4VOsU9q.png" alt="Omni-Web Creator Logo" class="h-8 w-8">
                <h1 class="text-xl font-bold text-gray-800">Omni-Web Creator</h1>
                <span id="projectName" class="text-sm text-gray-500 ml-4">New Project</span>
            </div>
            <div class="flex items-center space-x-2">
                <button id="newProjectBtn" class="btn-outline px-3 py-1.5 rounded-md text-sm flex items-center space-x-2"><i data-lucide="file-plus-2"></i><span>New</span></button>
                <button id="saveProjectBtn" class="btn-outline px-3 py-1.5 rounded-md text-sm flex items-center space-x-2"><i data-lucide="save"></i><span>Save</span></button>
                <button id="loadProjectBtn" class="btn-outline px-3 py-1.5 rounded-md text-sm flex items-center space-x-2"><i data-lucide="folder-open"></i><span>Load</span></button>
                <input type="file" id="loadProjectInput" class="hidden" accept=".wsb">
                <button id="generateWebsiteBtn" class="btn-primary px-4 py-1.5 rounded-md text-sm font-semibold flex items-center space-x-2"><i data-lucide="download-cloud"></i><span>Export Website</span></button>
            </div>
        </header>

        <!-- Main Content -->
        <main class="flex flex-1 overflow-hidden">
            <!-- Left Controls Panel -->
            <aside class="control-panel w-80 p-4 overflow-y-auto flex-shrink-0 border-r border-gray-200">
                <!-- Pages Section -->
                <div class="mb-6">
                    <h2 class="text-sm font-semibold text-gray-600 mb-2">PAGES</h2>
                    <div id="pageList" class="space-y-1 mb-2"></div>
                    <button id="addPageBtn" class="w-full btn-outline py-2 rounded-md text-sm">+ Add New Page</button>
                </div>

                <!-- Add Elements Section -->
                <div class="mb-6">
                    <h2 class="text-sm font-semibold text-gray-600 mb-2">ELEMENTS</h2>
                    <div class="grid grid-cols-2 gap-2">
                        <button class="add-element-btn btn-outline p-2 rounded-md flex flex-col items-center" data-type="header"><i data-lucide="heading-1"></i><span class="text-xs mt-1">Header</span></button>
                        <button class="add-element-btn btn-outline p-2 rounded-md flex flex-col items-center" data-type="subheader"><i data-lucide="heading-2"></i><span class="text-xs mt-1">Sub-Header</span></button>
                        <button class="add-element-btn btn-outline p-2 rounded-md flex flex-col items-center" data-type="paragraph"><i data-lucide="pilcrow"></i><span class="text-xs mt-1">Paragraph</span></button>
                        <button class="add-element-btn btn-outline p-2 rounded-md flex flex-col items-center" data-type="image"><i data-lucide="image"></i><span class="text-xs mt-1">Image</span></button>
                         <button class="add-element-btn btn-outline p-2 rounded-md flex flex-col items-center" data-type="video"><i data-lucide="video"></i><span class="text-xs mt-1">Video</span></button>
                        <button class="add-element-btn btn-outline p-2 rounded-md flex flex-col items-center" data-type="button"><i data-lucide="mouse-pointer-square"></i><span class="text-xs mt-1">Button</span></button>
                        <button class="add-element-btn btn-outline p-2 rounded-md flex flex-col items-center col-span-2" data-type="dropdown"><i data-lucide="menu-square"></i><span class="text-xs mt-1">Dropdown Menu</span></button>
                    </div>
                </div>

                <!-- Global Styles / Properties Panel -->
                <div id="propertiesPanel" class="space-y-4">
                    <!-- This will be dynamically populated -->
                </div>
            </aside>

            <!-- Center Canvas -->
            <div class="flex-1 flex flex-col items-center justify-center p-4" id="canvas-bg">
                <div id="canvas-wrapper" class="w-full h-full shadow-lg rounded-lg overflow-auto">
                    <div id="canvas" class="p-8">
                        <!-- Website elements will be rendered here -->
                    </div>
                </div>
            </div>
        </main>
        <!-- Footer -->
        <footer class="text-center p-2 bg-gray-100 border-t border-gray-200 text-xs text-gray-500">
            Made by king_of_coding, owned by Omni-Science
        </footer>
    </div>

    <!-- Modals (hidden by default) -->
    <div id="modalContainer"></div>


<script>
document.addEventListener('DOMContentLoaded', () => {
    lucide.createIcons();

    // --- STATE MANAGEMENT ---
    let projectData = {};
    let currentPage = 'index.html';
    let selectedElementIndex = null;
    let images = {}; // Store image data as base64

    // --- DOM REFERENCES ---
    const pageList = document.getElementById('pageList');
    const addPageBtn = document.getElementById('addPageBtn');
    const canvas = document.getElementById('canvas');
    const propertiesPanel = document.getElementById('propertiesPanel');
    const addElementBtns = document.querySelectorAll('.add-element-btn');
    const newProjectBtn = document.getElementById('newProjectBtn');
    const saveProjectBtn = document.getElementById('saveProjectBtn');
    const loadProjectBtn = document.getElementById('loadProjectBtn');
    const loadProjectInput = document.getElementById('loadProjectInput');
    const generateWebsiteBtn = document.getElementById('generateWebsiteBtn');
    const projectNameEl = document.getElementById('projectName');

    // --- INITIALIZATION ---
    function init() {
        newProject();
    }

    function newProject() {
        projectData = {
            "index.html": {
                elements: [],
                styles: getDefaultStyles()
            },
            themes: {
                'Default': {
                    primary: '#4f46e5',
                    secondary: '#10b981',
                    background: '#ffffff',
                    foreground: '#f3f4f6',
                    'text-primary': '#1f2937',
                    'text-secondary': '#4b5563',
                    accent: '#ec4899',
                }
            },
            currentTheme: 'Default'
        };
        images = {};
        currentPage = 'index.html';
        selectedElementIndex = null;
        projectNameEl.textContent = 'New Project';
        updateAll();
    }

    function getDefaultStyles() {
        return {
            backgroundColor: "#FFFFFF",
            fontColor: "#1f2937",
            fontFamily: "Inter",
            headerFontSize: 32,
            subHeaderFontSize: 24,
            paragraphFontSize: 16
        };
    }

    // --- CORE RENDER FUNCTIONS ---
    function updateAll() {
        applyTheme();
        renderPageList();
        renderCanvas();
        renderPropertiesPanel();
    }

    function applyTheme() {
        const theme = projectData.themes[projectData.currentTheme];
        if (!theme) return;
        for (const [key, value] of Object.entries(theme)) {
            document.documentElement.style.setProperty(`--${key}`, value);
        }
    }

    function renderPageList() {
        pageList.innerHTML = '';
        Object.keys(projectData).filter(p => p !== 'themes' && p !== 'currentTheme').sort().forEach(pageName => {
            const isActive = pageName === currentPage;
            const pageItem = document.createElement('div');
            pageItem.className = `flex justify-between items-center px-3 py-2 rounded-md cursor-pointer ${isActive ? 'bg-indigo-100 text-primary' : 'hover:bg-gray-100'}`;
            pageItem.textContent = pageName;
            pageItem.onclick = () => switchPage(pageName);
            
            if (pageName !== 'index.html') {
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4 text-gray-500 hover:text-red-500"></i>';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    removePage(pageName);
                };
                pageItem.appendChild(deleteBtn);
            }
            
            pageList.appendChild(pageItem);
        });
        lucide.createIcons();
    }

    function renderCanvas() {
        const page = projectData[currentPage];
        if (!page) return;

        // Apply global styles to canvas wrapper
        const theme = projectData.themes[projectData.currentTheme];
        document.getElementById('canvas-bg').style.backgroundColor = theme.foreground;
        const canvasWrapper = document.getElementById('canvas-wrapper');
        canvasWrapper.style.backgroundColor = theme.background;
        canvasWrapper.style.color = theme['text-primary'];
        canvasWrapper.style.fontFamily = page.styles.fontFamily;

        canvas.innerHTML = '';
        if (page.elements.length === 0) {
            canvas.innerHTML = `
                <div class="text-center text-gray-400 py-20">
                    <p>Your page is empty.</p>
                    <p class="text-sm">Click on an element from the left panel to add it here.</p>
                </div>
            `;
        }

        page.elements.forEach((element, index) => {
            const elWrapper = document.createElement('div');
            elWrapper.className = `element-frame p-2 border border-transparent rounded-lg ${selectedElementIndex === index ? 'selected' : ''}`;
            elWrapper.draggable = true;
            elWrapper.dataset.index = index;
            elWrapper.style.textAlign = element.align || 'left';
            
            if (element.link && element.link.href) {
                 const badge = document.createElement('div');
                 badge.className = 'link-badge';
                 badge.innerHTML = '<i data-lucide="link" class="w-3 h-3"></i>';
                 elWrapper.appendChild(badge);
            }
            
            elWrapper.addEventListener('click', (e) => {
                e.stopPropagation();
                selectElement(index);
            });

            const elContent = renderElement(element);
            elWrapper.appendChild(elContent);
            canvas.appendChild(elWrapper);
        });
        
        lucide.createIcons();
        setupDragAndDrop();
    }
    
    function renderElement(element) {
        const el = document.createElement('div');
        el.style.display = 'inline-block';
        el.style.textAlign = 'left'; // Reset inner content alignment
        
        const pageStyles = projectData[currentPage].styles;
        
        switch (element.type) {
            case 'header':
            case 'subheader':
            case 'paragraph':
                const tagName = { header: 'h1', subheader: 'h2', paragraph: 'p' }[element.type];
                const textEl = document.createElement(tagName);
                textEl.textContent = element.content;
                
                const defaultSize = { header: pageStyles.headerFontSize, subheader: pageStyles.subHeaderFontSize, paragraph: pageStyles.paragraphFontSize }[element.type];
                textEl.style.fontSize = `${element.fontSize || defaultSize}px`;
                if(element.type.includes('header')) textEl.style.fontWeight = 'bold';
                
                el.appendChild(textEl);
                break;

            case 'image':
                const img = document.createElement('img');
                img.src = images[element.src] || 'https://placehold.co/300x200/e0e7ff/a5b4fc?text=Image';
                img.style.maxWidth = '100%';
                img.style.width = `${element.scale || 100}%`;
                el.appendChild(img);
                break;

            case 'video':
                 const videoText = document.createElement('div');
                 videoText.className = "p-4 border rounded-md bg-gray-100 text-gray-600";
                 videoText.innerHTML = `<i data-lucide="video" class="inline-block mr-2"></i>Video Placeholder: ${element.src || 'No source'}`;
                 el.appendChild(videoText);
                 setTimeout(() => lucide.createIcons(), 0);
                 break;

            case 'button':
                const btn = document.createElement('a'); // Use an anchor tag for semantics
                btn.href = element.href || '#';
                btn.textContent = element.text || 'Click Me';
                btn.onclick = (e) => e.preventDefault(); // Prevent navigation in builder
                btn.className = 'btn-primary px-4 py-2 rounded-md inline-block';
                el.appendChild(btn);
                break;
                
            case 'dropdown':
                 const ddFrame = document.createElement('div');
                 ddFrame.className = "inline-block relative";
                 
                 const ddButton = document.createElement('button');
                 ddButton.textContent = element.name;
                 ddButton.className = "text-white px-4 py-2 rounded-md";
                 ddButton.style.backgroundColor = projectData.themes[projectData.currentTheme]['text-primary'];
                 
                 const ddContent = document.createElement('div');
                 ddContent.className = "absolute bg-white shadow-lg rounded-md mt-1 py-1 hidden";
                 element.items.forEach(item => {
                     const itemLink = document.createElement('a');
                     itemLink.href = item.href;
                     itemLink.textContent = item.text;
                     itemLink.className = "block px-4 py-2 text-gray-800 hover:bg-gray-100";
                     ddContent.appendChild(itemLink);
                 });
                 
                 ddFrame.appendChild(ddButton);
                 ddFrame.appendChild(ddContent);
                 
                 ddButton.addEventListener('mouseover', () => ddContent.classList.remove('hidden'));
                 ddFrame.addEventListener('mouseleave', () => ddContent.classList.add('hidden'));

                 el.appendChild(ddFrame);
                 break;
        }
        return el;
    }


    function renderPropertiesPanel() {
        propertiesPanel.innerHTML = '';
        const element = selectedElementIndex !== null ? projectData[currentPage].elements[selectedElementIndex] : null;

        if (element) {
            // Element specific properties
            const title = document.createElement('h2');
            title.className = 'text-sm font-semibold text-gray-600 mb-2 uppercase';
            title.textContent = `${element.type} Properties`;
            propertiesPanel.appendChild(title);

            // Alignment
            propertiesPanel.appendChild(createAlignmentControls(element));
            propertiesPanel.appendChild(createSeparator());

            switch(element.type) {
                case 'header':
                case 'subheader':
                case 'paragraph':
                    propertiesPanel.appendChild(createTextInput('Content', element.content, (val) => updateElement('content', val)));
                    propertiesPanel.appendChild(createNumberInput('Font Size (px)', element.fontSize, (val) => updateElement('fontSize', parseInt(val, 10))));
                    break;
                case 'image':
                    propertiesPanel.appendChild(createFileUpload('Image Source', 'image/*', (file) => {
                        const reader = new FileReader();
                        reader.onload = (e) => {
                            images[file.name] = e.target.result;
                            updateElement('src', file.name);
                        };
                        reader.readAsDataURL(file);
                    }));
                    propertiesPanel.appendChild(createRangeInput('Scale (%)', element.scale || 100, 10, 200, (val) => updateElement('scale', parseInt(val, 10))));
                    break;
                case 'video':
                    propertiesPanel.appendChild(createTextInput('Video URL', element.src, (val) => updateElement('src', val), 'YouTube, Vimeo, or file URL'));
                    break;
                case 'button':
                    propertiesPanel.appendChild(createTextInput('Button Text', element.text, (val) => updateElement('text', val)));
                    propertiesPanel.appendChild(createUrlInput('Link URL', element.href, (val) => updateElement('href', val)));
                    break;
                case 'dropdown':
                    propertiesPanel.appendChild(createTextInput('Menu Name', element.name, (val) => updateElement('name', val)));
                    propertiesPanel.appendChild(createSeparator());
                    propertiesPanel.appendChild(createDropdownItemsEditor(element));
                    break;
            }
            
            // Add linking capabilities to all elements
            propertiesPanel.appendChild(createSeparator());
            propertiesPanel.appendChild(createLinkEditor(element));

            propertiesPanel.appendChild(createSeparator());

            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'w-full btn-outline border-red-300 text-red-600 hover:bg-red-50 py-2 rounded-md text-sm';
            deleteBtn.innerHTML = '<i data-lucide="trash-2" class="inline-block w-4 h-4 mr-2"></i>Delete Element';
            deleteBtn.onclick = deleteElement;
            propertiesPanel.appendChild(deleteBtn);
            lucide.createIcons();

        } else {
            // Global styles
            const title = document.createElement('h2');
            title.className = 'text-sm font-semibold text-gray-600 mb-2 uppercase';
            title.textContent = 'Global Page Styles';
            propertiesPanel.appendChild(title);
            
            propertiesPanel.appendChild(createThemeManager());
            propertiesPanel.appendChild(createSeparator());

            const pageStyles = projectData[currentPage].styles;
            const fonts = ['Inter', 'Arial', 'Georgia', 'Times New Roman', 'Verdana'];
            propertiesPanel.appendChild(createSelectInput('Font Family', pageStyles.fontFamily, fonts, (val) => updateStyle('fontFamily', val)));
        }
    }

    // --- PROPERTY PANEL UI BUILDERS ---
    function createSeparator() {
        const sep = document.createElement('hr');
        sep.className = 'my-4';
        return sep;
    }

    function createInputWrapper(label) {
        const wrapper = document.createElement('div');
        wrapper.className = 'mb-3';
        const labelEl = document.createElement('label');
        labelEl.className = 'block text-xs font-medium text-gray-500 mb-1';
        labelEl.textContent = label;
        wrapper.appendChild(labelEl);
        return wrapper;
    }

    function createTextInput(label, value, onChange, placeholder = '') {
        const wrapper = createInputWrapper(label);
        const input = document.createElement('input');
        input.type = 'text';
        input.value = value || '';
        input.placeholder = placeholder;
        input.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-primary focus:border-primary';
        input.oninput = (e) => onChange(e.target.value);
        wrapper.appendChild(input);
        return wrapper;
    }

    function createUrlInput(label, value, onChange) {
        const wrapper = createInputWrapper(label);
        const input = document.createElement('input');
        input.type = 'text';
        input.value = value || '';
        input.setAttribute('list', 'pages-datalist');
        input.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-primary focus:border-primary';
        input.oninput = (e) => onChange(e.target.value);
        
        const datalist = document.createElement('datalist');
        datalist.id = 'pages-datalist';
        Object.keys(projectData)
            .filter(p => p.endsWith('.html'))
            .forEach(page => {
                const option = document.createElement('option');
                option.value = page;
                datalist.appendChild(option);
            });

        wrapper.appendChild(input);
        wrapper.appendChild(datalist);
        return wrapper;
    }

    function createNumberInput(label, value, onChange) {
        const wrapper = createInputWrapper(label);
        const input = document.createElement('input');
        input.type = 'number';
        input.value = value || '';
        input.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-primary focus:border-primary';
        input.oninput = (e) => onChange(e.target.value);
        wrapper.appendChild(input);
        return wrapper;
    }
    
    function createRangeInput(label, value, min, max, onChange) {
        const wrapper = createInputWrapper(`${label}: ${value}`);
        const input = document.createElement('input');
        input.type = 'range';
        input.min = min;
        input.max = max;
        input.value = value || 100;
        input.className = 'w-full';
        input.oninput = (e) => {
            wrapper.querySelector('label').textContent = `${label}: ${e.target.value}`;
            onChange(e.target.value)
        };
        wrapper.appendChild(input);
        return wrapper;
    }

    function createColorInput(label, value, onChange) {
        const wrapper = createInputWrapper(label);
        const colorContainer = document.createElement('div');
        colorContainer.className = 'flex items-center space-x-2';
        const input = document.createElement('input');
        input.type = 'color';
        input.value = value || '#ffffff';
        input.className = 'w-8 h-8 p-0 border-none rounded';
        const textInput = document.createElement('input');
        textInput.type = 'text';
        textInput.value = value || '#ffffff';
        textInput.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm';
        
        input.oninput = (e) => {
            textInput.value = e.target.value;
            onChange(e.target.value);
        };
        textInput.oninput = (e) => {
            input.value = e.target.value;
            onChange(e.target.value);
        }

        colorContainer.appendChild(input);
        colorContainer.appendChild(textInput);
        wrapper.appendChild(colorContainer);
        return wrapper;
    }
    
    function createSelectInput(label, value, options, onChange) {
        const wrapper = createInputWrapper(label);
        const select = document.createElement('select');
        select.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm focus:ring-1 focus:ring-primary focus:border-primary';
        options.forEach(opt => {
            const optionEl = document.createElement('option');
            optionEl.value = opt;
            optionEl.textContent = opt;
            if (opt === value) optionEl.selected = true;
            select.appendChild(optionEl);
        });
        select.onchange = (e) => onChange(e.target.value);
        wrapper.appendChild(select);
        return wrapper;
    }

    function createFileUpload(label, accept, onFile) {
        const wrapper = createInputWrapper(label);
        const input = document.createElement('input');
        input.type = 'file';
        input.accept = accept;
        input.className = 'text-sm';
        input.onchange = (e) => {
            if (e.target.files.length > 0) {
                onFile(e.target.files[0]);
            }
        };
        wrapper.appendChild(input);
        return wrapper;
    }
    
    function createAlignmentControls(element) {
        const wrapper = createInputWrapper('Alignment');
        const container = document.createElement('div');
        container.className = 'flex items-center space-x-1';
        ['left', 'center', 'right'].forEach(align => {
            const btn = document.createElement('button');
            btn.className = `p-2 rounded-md ${element.align === align ? 'bg-indigo-100 text-primary' : 'hover:bg-gray-100'}`;
            btn.innerHTML = `<i data-lucide="align-${align}"></i>`;
            btn.onclick = () => updateElement('align', align);
            container.appendChild(btn);
        });
        wrapper.appendChild(container);
        lucide.createIcons();
        return wrapper;
    }

    function createDropdownItemsEditor(element) {
        const wrapper = createInputWrapper('Menu Items');
        const itemsContainer = document.createElement('div');
        itemsContainer.className = 'space-y-2';

        function renderItems() {
            itemsContainer.innerHTML = '';
            element.items.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'flex items-center space-x-2 bg-gray-50 p-2 rounded';
                const textInput = document.createElement('input');
                textInput.type = 'text';
                textInput.value = item.text;
                textInput.placeholder = 'Item Text';
                textInput.className = 'flex-grow px-2 py-1 border border-gray-300 rounded-md text-sm';
                textInput.oninput = (e) => {
                    element.items[index].text = e.target.value;
                    renderCanvas();
                };

                const hrefInput = createUrlInput('', item.href, (val) => {
                    element.items[index].href = val;
                }).querySelector('input');
                hrefInput.className = 'flex-grow px-2 py-1 border border-gray-300 rounded-md text-sm';
                hrefInput.placeholder = 'URL or #';
                

                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i data-lucide="trash-2" class="w-4 h-4 text-gray-500 hover:text-red-500"></i>';
                deleteBtn.onclick = () => {
                    element.items.splice(index, 1);
                    renderItems();
                    renderCanvas();
                };

                itemDiv.appendChild(textInput);
                itemDiv.appendChild(hrefInput.parentElement);
                itemDiv.appendChild(deleteBtn);
                itemsContainer.appendChild(itemDiv);
            });
            lucide.createIcons();
        }

        const addItemBtn = document.createElement('button');
        addItemBtn.className = 'btn-outline w-full py-1.5 rounded-md text-sm mt-2';
        addItemBtn.textContent = '+ Add Item';
        addItemBtn.onclick = () => {
            element.items.push({text: 'New Item', href: '#'});
            renderItems();
            renderCanvas();
        };
        
        renderItems();
        wrapper.appendChild(itemsContainer);
        wrapper.appendChild(addItemBtn);
        return wrapper;
    }

    function createLinkEditor(element) {
        const wrapper = createInputWrapper('Element Link');
        const linkData = element.link || { href: '', newTab: false };

        const urlInput = createUrlInput('', linkData.href, (val) => {
            if (!element.link) element.link = {};
            element.link.href = val;
            renderCanvas(); // to show/hide badge
        });
        
        const checkboxWrapper = document.createElement('div');
        checkboxWrapper.className = 'flex items-center mt-2';
        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.id = 'link-new-tab';
        checkbox.checked = linkData.newTab;
        checkbox.className = 'h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary';
        checkbox.onchange = (e) => {
            if (!element.link) element.link = {};
            element.link.newTab = e.target.checked;
        };
        const checkLabel = document.createElement('label');
        checkLabel.htmlFor = 'link-new-tab';
        checkLabel.textContent = 'Open in new tab';
        checkLabel.className = 'ml-2 block text-sm text-gray-700';
        
        checkboxWrapper.appendChild(checkbox);
        checkboxWrapper.appendChild(checkLabel);
        
        wrapper.appendChild(urlInput);
        wrapper.appendChild(checkboxWrapper);
        return wrapper;
    }
    
    function createThemeManager() {
        const wrapper = createInputWrapper('Website Theme');
        const container = document.createElement('div');
        container.className = 'flex items-center space-x-2';
        
        const select = createSelectInput('', projectData.currentTheme, Object.keys(projectData.themes), (val) => {
            projectData.currentTheme = val;
            updateAll();
        }).querySelector('select');
        select.className += ' flex-grow';

        const manageBtn = document.createElement('button');
        manageBtn.className = 'btn-outline p-2 rounded-md';
        manageBtn.innerHTML = '<i data-lucide="settings-2" class="w-4 h-4"></i>';
        manageBtn.onclick = showThemeManagerModal;

        container.appendChild(select);
        container.appendChild(manageBtn);
        wrapper.appendChild(container);
        lucide.createIcons();
        return wrapper;
    }


    // --- DATA MUTATION & ACTIONS ---
    function switchPage(pageName) {
        currentPage = pageName;
        selectedElementIndex = null;
        updateAll();
    }

    function addPage() {
        showModal('Add New Page', [
            { type: 'text', name: 'pageName', label: 'Page Name (e.g., about)' }
        ], (formData) => {
            let name = (formData.pageName || `page${Object.keys(projectData).length + 1}`).trim().replace(/\s+/g, '-').toLowerCase();
            if (!name.endsWith('.html')) name += '.html';
            if (projectData[name]) {
                alert('Page with this name already exists.');
                return;
            }
            projectData[name] = { elements: [], styles: getDefaultStyles() };
            switchPage(name);
        });
    }

    function removePage(pageName) {
         if (confirm(`Are you sure you want to delete ${pageName}?`)) {
            delete projectData[pageName];
            if (currentPage === pageName) {
                switchPage('index.html');
            } else {
                renderPageList();
            }
        }
    }

    function addElement(type) {
        const page = projectData[currentPage];
        if (!page) return;

        let newElement = { type, align: 'left' };
        if (type === 'header') newElement.content = "Main Header";
        if (type === 'subheader') newElement.content = "Sub-Header";
        if (type === 'paragraph') newElement.content = "This is a paragraph of text. You can edit this content in the properties panel.";
        if (type === 'image') { newElement.src = ""; newElement.scale = 100; }
        if (type === 'video') newElement.src = "";
        if (type === 'button') { newElement.text = "Clickable Button"; newElement.href = "#"; }
        if (type === 'dropdown') { newElement.name = "Dropdown"; newElement.items = [{ text: "Item 1", href: "#"}, { text: "Item 2", href: "#"}]; }

        page.elements.push(newElement);
        selectElement(page.elements.length - 1);
    }
    
    function selectElement(index) {
        selectedElementIndex = index;
        renderCanvas();
        renderPropertiesPanel();
    }
    
    function unselectElement() {
        selectedElementIndex = null;
        renderCanvas();
        renderPropertiesPanel();
    }

    function deleteElement() {
        if (selectedElementIndex !== null) {
            projectData[currentPage].elements.splice(selectedElementIndex, 1);
            selectedElementIndex = null;
            updateAll();
        }
    }
    
    function updateElement(prop, value) {
        if (selectedElementIndex !== null) {
            projectData[currentPage].elements[selectedElementIndex][prop] = value;
            renderCanvas();
            renderPropertiesPanel();
        }
    }
    
    function updateStyle(prop, value) {
        projectData[currentPage].styles[prop] = value;
        renderCanvas();
        renderPropertiesPanel();
    }
    
    function moveElement(fromIndex, toIndex) {
        const elements = projectData[currentPage].elements;
        const [movedElement] = elements.splice(fromIndex, 1);
        elements.splice(toIndex, 0, movedElement);
        selectElement(toIndex);
    }


    // --- DRAG & DROP ---
    let draggedItem = null;
    function setupDragAndDrop() {
        canvas.addEventListener('dragover', handleCanvasDragOver);
        canvas.addEventListener('drop', handleDrop);

        const elements = canvas.querySelectorAll('.element-frame');
        elements.forEach(el => {
            el.addEventListener('dragstart', handleDragStart);
            el.addEventListener('dragend', handleDragEnd);
        });
    }

    function handleDragStart(e) {
        if (e.target.classList.contains('element-frame')) {
            draggedItem = e.target;
            e.dataTransfer.effectAllowed = 'move';
            setTimeout(() => {
                draggedItem.classList.add('dragging');
            }, 0);
        } else {
            e.preventDefault();
        }
    }
    
    function getDragAfterElement(container, y) {
        const draggableElements = [...container.querySelectorAll('.element-frame:not(.dragging)')];

        return draggableElements.reduce((closest, child) => {
            const box = child.getBoundingClientRect();
            const offset = y - box.top - box.height / 2;
            if (offset < 0 && offset > closest.offset) {
                return { offset: offset, element: child };
            } else {
                return closest;
            }
        }, { offset: Number.NEGATIVE_INFINITY }).element;
    }

    function handleCanvasDragOver(e) {
        e.preventDefault();
        const afterElement = getDragAfterElement(canvas, e.clientY);
        const placeholder = document.querySelector('.placeholder');
        
        if (!placeholder) {
            const newPlaceholder = document.createElement('div');
            newPlaceholder.className = 'placeholder';
            if (afterElement == null) {
                canvas.appendChild(newPlaceholder);
            } else {
                canvas.insertBefore(newPlaceholder, afterElement);
            }
        } else {
            if (afterElement == null) {
                canvas.appendChild(placeholder);
            } else {
                canvas.insertBefore(placeholder, afterElement);
            }
        }
    }
    
    function handleDrop(e) {
        e.preventDefault();
        const placeholder = canvas.querySelector('.placeholder');
        if (!placeholder || !draggedItem) return;

        const fromIndex = parseInt(draggedItem.dataset.index, 10);
        
        const children = Array.from(canvas.children).filter(child => 
            child.classList.contains('element-frame') || child.classList.contains('placeholder')
        );
        let toIndex = children.indexOf(placeholder);

        const originalItemInFilteredArray = children.indexOf(draggedItem);
        if (originalItemInFilteredArray !== -1 && originalItemInFilteredArray < toIndex) {
            toIndex--;
        }
        
        placeholder.remove();
        if (fromIndex !== toIndex) {
            moveElement(fromIndex, toIndex);
        } else {
            renderCanvas();
        }
    }

    function handleDragEnd(e) {
        document.querySelectorAll('.placeholder').forEach(p => p.remove());
        if (draggedItem) {
            draggedItem.classList.remove('dragging');
        }
        draggedItem = null;
        renderCanvas();
    }
    
    // --- FILE HANDLING ---
    function saveProject() {
        const dataStr = JSON.stringify({ projectData, images }, null, 2);
        const blob = new Blob([dataStr], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'website-project.wsb';
        a.click();
        URL.revokeObjectURL(url);
    }

    function loadProject(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (event) => {
            try {
                const data = JSON.parse(event.target.result);
                projectData = data.projectData;
                images = data.images || {};
                currentPage = 'index.html';
                selectedElementIndex = null;
                projectNameEl.textContent = file.name.replace('.wsb', '');
                updateAll();
            } catch (err) {
                alert('Error: Invalid project file.');
                console.error(err);
            }
        };
        reader.readAsText(file);
        loadProjectInput.value = '';
    }
    
    function generateWebsite() {
        const zip = new JSZip();
        const assets = zip.folder("assets");
        const usedImages = new Set();
        
        Object.entries(projectData).forEach(([pageName, pageData]) => {
            if (typeof pageData !== 'object' || !pageData.elements) return;
             pageData.elements.forEach(el => {
                if (el.type === 'image' && el.src && images[el.src]) {
                    usedImages.add(el.src);
                }
            });
        });

        usedImages.forEach(imgName => {
            const base64Data = images[imgName].split(',')[1];
            assets.file(imgName, base64Data, { base64: true });
        });

        Object.entries(projectData).forEach(([pageName, pageData]) => {
            if (pageName.endsWith('.html')) {
                zip.file(pageName, generatePageHTML(pageName, pageData));
            }
        });

        zip.generateAsync({ type: "blob" })
            .then(function(content) {
                const url = URL.createObjectURL(content);
                const a = document.createElement('a');
                a.href = url;
                a.download = "website.zip";
                a.click();
                URL.revokeObjectURL(url);
            });
    }

    function generatePageHTML(pageName, pageData) {
        const styles = pageData.styles;
        const theme = projectData.themes[projectData.currentTheme];
        const title = pageName.replace('.html', '').replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        let bodyContent = "";
        for (const el of pageData.elements) {
            const alignStyle = `text-align: ${el.align || 'left'};`;
            let elementHTML = '';

            switch (el.type) {
                case 'header': elementHTML = `<h1 style="font-size:${el.fontSize || styles.headerFontSize}px; font-weight: bold;">${el.content}</h1>`; break;
                case 'subheader': elementHTML = `<h2 style="font-size:${el.fontSize || styles.subHeaderFontSize}px; font-weight: bold;">${el.content}</h2>`; break;
                case 'paragraph': elementHTML = `<p style="font-size:${el.fontSize || styles.paragraphFontSize}px;">${el.content}</p>`; break;
                case 'button':
                    elementHTML = `<a href="${el.href}" style="background-color:${theme.primary}; color:white; padding: 10px 20px; text-decoration:none; border-radius: 5px; display:inline-block;">${el.text}</a>`;
                    break;
                case 'image':
                    if (el.src) {
                        elementHTML = `<img src="assets/${el.src}" alt="Image" style="width:${el.scale || 100}%; max-width:100%; display:inline-block;">`;
                    }
                    break;
                case 'video':
                    if (el.src) {
                        if (el.src.includes('youtube.com/embed') || el.src.includes('player.vimeo.com/video')) {
                            elementHTML = `<iframe width="560" height="315" src="${el.src}" frameborder="0" allowfullscreen style="max-width:100%; display:inline-block;"></iframe>`;
                        } else {
                             elementHTML = `<video controls style="max-width:100%; display:inline-block;"><source src="assets/${el.src}"></video>`;
                        }
                    }
                    break;
                case 'dropdown':
                    let itemsHTML = el.items.map(item => `<a href="${item.href}" style="display:block; padding: 8px 16px; color: ${theme['text-primary']}; text-decoration: none;">${item.text}</a>`).join('');
                    elementHTML = `
                        <div class="dropdown" style="position:relative; display:inline-block;">
                            <button class="dropbtn" style="background-color:${theme['text-primary']}; color:white; padding: 12px; font-size: 16px; border:none; cursor:pointer;">${el.name}</button>
                            <div class="dropdown-content" style="display:none; position:absolute; background-color:${theme.foreground}; min-width:160px; box-shadow:0 8px 16px 0 rgba(0,0,0,0.2); z-index:1;">
                                ${itemsHTML}
                            </div>
                        </div>`;
                    break;
            }
            
            if (el.link && el.link.href) {
                elementHTML = `<a href="${el.link.href}" ${el.link.newTab ? 'target="_blank"' : ''} style="text-decoration:none; color:inherit;">${elementHTML}</a>`;
            }

            bodyContent += `<div style="${alignStyle}; margin: 16px 0;">${elementHTML}</div>\n`;
        }

        const dropdownCSS = `
            .dropdown:hover .dropdown-content { display: block; }
            .dropdown-content a:hover { background-color: ${theme.background}; }
        `;

        return `<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>${title}</title>
    <style>
        body {
            background-color: ${theme.background};
            color: ${theme['text-primary']};
            font-family: "${styles.fontFamily}", sans-serif;
            margin: 2em;
        }
        ${dropdownCSS}
    </style>
</head>
<body>
    ${bodyContent}
</body>
</html>`;
    }

    // --- MODALS ---
    function showModal(title, content, showButtons = true, onSubmit) {
        const modalContainer = document.getElementById('modalContainer');
        modalContainer.innerHTML = ''; // Clear previous modals
        const backdrop = document.createElement('div');
        backdrop.className = 'modal-backdrop';
        const modal = document.createElement('div');
        modal.className = 'modal-content';
        modal.innerHTML = `<h2 class="text-lg font-bold mb-4">${title}</h2>`;
        
        const form = document.createElement('form');
        form.className = 'space-y-4';
        
        if (typeof content === 'function') {
            content(form); // For complex content
        } else {
            // For simple fields array
            content.forEach(field => {
                const wrapper = createInputWrapper(field.label);
                const input = document.createElement('input');
                input.type = field.type;
                input.name = field.name;
                input.className = 'w-full px-2 py-1.5 border border-gray-300 rounded-md text-sm';
                input.required = true;
                wrapper.appendChild(input);
                form.appendChild(wrapper);
            });
        }
        
        if (showButtons) {
            const btnContainer = document.createElement('div');
            btnContainer.className = 'flex justify-end space-x-2 mt-6';
            const cancelBtn = document.createElement('button');
            cancelBtn.type = 'button';
            cancelBtn.textContent = 'Cancel';
            cancelBtn.className = 'btn-outline px-4 py-1.5 rounded-md text-sm';
            cancelBtn.onclick = () => modalContainer.innerHTML = '';
            const submitBtn = document.createElement('button');
            submitBtn.type = 'submit';
            submitBtn.textContent = 'OK';
            submitBtn.className = 'btn-primary px-4 py-1.5 rounded-md text-sm';

            btnContainer.appendChild(cancelBtn);
            btnContainer.appendChild(submitBtn);
            form.appendChild(btnContainer);
        }
        
        form.onsubmit = (e) => {
            e.preventDefault();
            const formData = new FormData(form);
            const data = Object.fromEntries(formData.entries());
            if (onSubmit) onSubmit(data);
            modalContainer.innerHTML = '';
        };

        modal.appendChild(form);
        backdrop.appendChild(modal);
        modalContainer.appendChild(backdrop);
    }
    
    function showThemeManagerModal() {
        showModal('Theme Manager', (form) => {
            const themes = projectData.themes;
            const themeKeys = ['primary', 'secondary', 'background', 'foreground', 'text-primary', 'text-secondary', 'accent'];
            let selectedTheme = projectData.currentTheme;

            const selector = createSelectInput('Select Theme to Edit', selectedTheme, Object.keys(themes), (val) => {
                selectedTheme = val;
                updateEditor();
            }).querySelector('select');

            const editor = document.createElement('div');
            editor.className = 'grid grid-cols-1 md:grid-cols-2 gap-4 border-t pt-4 mt-4';
            
            function updateEditor() {
                editor.innerHTML = '';
                const theme = themes[selectedTheme];
                const isDefault = selectedTheme === 'Default';

                themeKeys.forEach(key => {
                    const colorInput = createColorInput(key, theme[key], (val) => {
                        if (isDefault) return;
                        themes[selectedTheme][key] = val;
                        applyTheme();
                        renderCanvas(); // Force canvas re-render
                    });

                    if (isDefault) {
                        colorInput.querySelectorAll('input').forEach(i => i.disabled = true);
                    }
                    editor.appendChild(colorInput);
                });
                
                if (isDefault) {
                    const notice = document.createElement('p');
                    notice.className = 'text-xs text-gray-500 col-span-2 text-center mt-2';
                    notice.textContent = 'Default theme is read-only. Create a new theme to customize colors.';
                    editor.appendChild(notice);
                }
            }
            
            const newThemeContainer = document.createElement('div');
            newThemeContainer.className = 'flex items-center space-x-2 mt-4';
            const newThemeName = document.createElement('input');
            newThemeName.type = 'text';
            newThemeName.placeholder = 'New Theme Name';
            newThemeName.className = 'flex-grow px-2 py-1.5 border border-gray-300 rounded-md text-sm';
            const addThemeBtn = document.createElement('button');
            addThemeBtn.type = 'button';
            addThemeBtn.textContent = 'Add Theme';
            addThemeBtn.className = 'btn-secondary px-3 py-1.5 rounded-md text-sm';
            addThemeBtn.onclick = () => {
                const name = newThemeName.value.trim();
                if (name && !themes[name]) {
                    themes[name] = { ...themes[selectedTheme] }; // clone current
                    projectData.currentTheme = name;
                    form.parentElement.parentElement.remove(); // close and reopen
                    showThemeManagerModal();
                    updateAll();
                } else {
                    alert('Invalid or duplicate theme name.');
                }
            };
            
            newThemeContainer.appendChild(newThemeName);
            newThemeContainer.appendChild(addThemeBtn);

            form.appendChild(selector.parentElement);
            form.appendChild(editor);
            form.appendChild(newThemeContainer);
            updateEditor();

            const closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.textContent = 'Done';
            closeBtn.className = 'btn-primary px-4 py-1.5 rounded-md text-sm float-right mt-4';
            closeBtn.onclick = () => form.parentElement.parentElement.remove();
            form.appendChild(closeBtn);

        }, false);
    }

    // --- EVENT LISTENERS ---
    addPageBtn.addEventListener('click', () => {
        showModal('Add New Page', [{ type: 'text', name: 'pageName', label: 'Page Name (e.g., about)' }], true, addPage);
    });
    addElementBtns.forEach(btn => {
        btn.addEventListener('click', () => addElement(btn.dataset.type));
    });
    canvas.addEventListener('click', (e) => {
        if (e.target.id === 'canvas' || e.target.id === 'canvas-wrapper') {
            unselectElement();
        }
    });

    newProjectBtn.addEventListener('click', () => {
        if(confirm('Are you sure you want to start a new project? Unsaved changes will be lost.')) {
            newProject();
        }
    });
    saveProjectBtn.addEventListener('click', saveProject);
    loadProjectBtn.addEventListener('click', () => loadProjectInput.click());
    loadProjectInput.addEventListener('change', loadProject);
    generateWebsiteBtn.addEventListener('click', generateWebsite);

    // --- KICK IT OFF ---
    init();
});
</script>

</body>
</html>




